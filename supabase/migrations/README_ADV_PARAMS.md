# Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ñ€ÐµÐºÐ»Ð°Ð¼Ð½Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ (adv_params)

## ðŸ“Š Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†

### 1. `adv_campaign_daily_stats` (Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°)
ÐšÐ°Ð¶Ð´Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° = Ð¾Ð´Ð¸Ð½ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ» Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ€ÐµÐºÐ»Ð°Ð¼Ð½Ð¾Ð¹ ÐºÐ°Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Ð·Ð° Ð¾Ð´Ð¸Ð½ Ð´ÐµÐ½ÑŒ.

**ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ:**
- `advert_id` - ID Ñ€ÐµÐºÐ»Ð°Ð¼Ð½Ð¾Ð¹ ÐºÐ°Ð¼Ð¿Ð°Ð½Ð¸Ð¸ WB
- `nm_id` - ÐÑ€Ñ‚Ð¸ÐºÑƒÐ» WB
- `vendor_code` - ÐÑ€Ñ‚Ð¸ÐºÑƒÐ» Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°
- `date` - Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÐµÐ¹
- `views`, `clicks`, `sum`, `orders` - ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸

**Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:** `(advert_id, nm_id, date)`

---

### 2. `adv_params` (Ð°Ð³Ñ€ÐµÐ³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°)
ÐšÐ°Ð¶Ð´Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° = Ð¾Ð´Ð¸Ð½ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ» Ð·Ð° Ð¾Ð´Ð¸Ð½ Ð´ÐµÐ½ÑŒ (ÑÑƒÐ¼Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð’Ð¡Ð• ÐºÐ°Ð¼Ð¿Ð°Ð½Ð¸Ð¸).

**ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ:**
- `nm_id` - ÐÑ€Ñ‚Ð¸ÐºÑƒÐ» WB
- `vendor_code` - ÐÑ€Ñ‚Ð¸ÐºÑƒÐ» Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°
- `date` - Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÐµÐ¹
- `views`, `clicks`, `sum`, `orders` - ÐÐ³Ñ€ÐµÐ³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
- **`updated_at`** - Ð’Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

**Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:** `(nm_id, date)`

---

## âš™ï¸ ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ `aggregate_adv_params(date_from, date_to)`

1. **Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ:** Ð‘ÐµÑ€ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¸Ð· `adv_campaign_daily_stats` Ð·Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´
2. **ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ:** Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ð¾ `(nm_id, date)` Ð¸ ÑÑƒÐ¼Ð¼Ð¸Ñ€ÑƒÐµÑ‚ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
3. **UPSERT:** Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð² `adv_params` Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ SQL Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°

```sql
SELECT
  nm_id,
  vendor_code,
  date,
  SUM(views) AS views,
  SUM(clicks) AS clicks,
  SUM(sum) AS sum,
  ...
FROM adv_campaign_daily_stats
WHERE date >= '2025-10-09' AND date <= '2025-10-11'  -- Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð´Ð°Ñ‚Ð°Ð¼
GROUP BY nm_id, vendor_code, date
```

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸

Ð•ÑÐ»Ð¸ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ» ÑƒÑ‡Ð°ÑÑ‚Ð²ÑƒÐµÑ‚ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÐºÐ°Ð¼Ð¿Ð°Ð½Ð¸ÑÑ…:

```
adv_campaign_daily_stats:
  campaign_1 | nm_id=123 | date=2025-10-09 | views=1000
  campaign_2 | nm_id=123 | date=2025-10-09 | views=500

â†“ ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ

adv_params:
  nm_id=123 | date=2025-10-09 | views=1500  (ÑÑƒÐ¼Ð¼Ð°)
```

---

## ðŸ”§ Ð ÐµÑˆÐµÐ½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°: updated_at

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° (Ð”Ðž Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ)

ÐŸÑ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ `aggregate_adv_params('2025-10-09', '2025-10-11')`:
- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð±Ñ€Ð°Ð»Ð° **Ð’Ð¡Ð•** Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð·Ð° ÑÑ‚Ð¾Ñ‚ Ð¿ÐµÑ€Ð¸Ð¾Ð´ (Ð¾Ñ‚ Ð²ÑÐµÑ… Ð˜ÐŸ: KUSKOV, NOSOV Ð¸ Ñ‚.Ð´.)
- Ð”ÐµÐ»Ð°Ð»Ð° UPSERT Ð² `adv_params`
- **Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€** Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐ» `updated_at = NOW()` Ð´Ð»Ñ **Ð’Ð¡Ð•Ð¥** Ð·Ð°Ð¿Ð¸ÑÐµÐ¹

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:** Ð•ÑÐ»Ð¸ KUSKOV Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ, `updated_at` Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð¸ Ð´Ð»Ñ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ð¾Ð² NOSOV! ðŸ˜±

### Ð ÐµÑˆÐµÐ½Ð¸Ðµ (ÐŸÐžÐ¡Ð›Ð• Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ)

1. **Ð£Ð´Ð°Ð»ÐµÐ½ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€** `update_adv_params_updated_at` Ð´Ð»Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ `adv_params`
2. **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ°** Ð² `ON CONFLICT`:

```sql
updated_at = CASE 
  WHEN (
    adv_params.views IS DISTINCT FROM EXCLUDED.views OR
    adv_params.clicks IS DISTINCT FROM EXCLUDED.clicks OR
    adv_params.sum IS DISTINCT FROM EXCLUDED.sum OR
    adv_params.orders IS DISTINCT FROM EXCLUDED.orders OR
    adv_params.orders_sum IS DISTINCT FROM EXCLUDED.orders_sum
  )
  THEN NOW()  -- ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
  ELSE adv_params.updated_at  -- ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
END
```

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚

âœ… `updated_at` Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ **Ð¢ÐžÐ›Ð¬ÐšÐž** Ð¿Ñ€Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…  
âœ… ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ Ñ‚ÐµÐ¼Ð¸ Ð¶Ðµ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ â†’ `updated_at` Ð½Ðµ Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ  
âœ… ÐÑ€Ñ‚Ð¸ÐºÑƒÐ»Ñ‹ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð˜ÐŸ Ð½Ðµ Ð²Ð»Ð¸ÑÑŽÑ‚ Ð´Ñ€ÑƒÐ³ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð° Ð¿Ð¾ `updated_at`

---

## ðŸŽ¯ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð—Ð°Ð¿ÑƒÑÐº Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´

```python
from supabase import create_client
import api_keys

supabase = create_client(api_keys.SUPABASE_URL, api_keys.SUPABASE_KEY)

# ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ð·Ð° 3 Ð´Ð½Ñ
response = supabase.rpc(
    'aggregate_adv_params',
    {
        'p_date_from': '2025-10-09',
        'p_date_to': '2025-10-11'
    }
).execute()

print(f"ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: {response.data}")
```

### Ð—Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· main Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ

```bash
cd "/Users/makar/ÐŸÑ€Ð¾ÐµÐºÑ‚Ñ‹ Cursor/Only Wildberries"
source venv/bin/activate
python3 main_function/adv_params_mf/adv_params_supabase.py --begin 2025-10-09 --end 2025-10-11
```

---

## ðŸ“š Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ

### Ð¡Ð²ÑÐ·ÑŒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†

```
products (nm_id, vendor_code)
    â†“ FK
adv_params (nm_id, date, updated_at)
    â†‘ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ
adv_campaign_daily_stats (advert_id, nm_id, date)
```

### Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹

- âœ… `update_adv_campaign_daily_stats_updated_at` - Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ (Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹)
- âŒ `update_adv_params_updated_at` - **Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½** (ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² RPC Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸)

### Ð˜Ð½Ð´ÐµÐºÑÑ‹

- `idx_adv_params_nm_id` - Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ñƒ
- `idx_adv_params_date` - Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ
- `ux_adv_params_nm_date` - ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ (nm_id, date)

---

## ðŸš¨ Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ

1. **ÐÐµ Ð°Ð³Ñ€ÐµÐ³Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ñ†ÐµÐ»Ð¸ÐºÐ¾Ð¼** - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´ (date_from â†’ date_to)
2. **Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾** - updated_at Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑÑ, ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ðµ Ð¶Ðµ
3. **ÐÐµÑ‚ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð˜ÐŸ** - ÐµÑÐ»Ð¸ KUSKOV Ð¸ NOSOV Ð¿Ñ€Ð¾Ð´Ð°ÑŽÑ‚ Ð¾Ð´Ð¸Ð½ nm_id, Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸
4. **updated_at Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ** - Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ, ÐºÐ¾Ð³Ð´Ð° Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ€Ð°Ð· Ð¼ÐµÐ½ÑÐ»Ð¸ÑÑŒ

---

## ðŸ“ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

**2025-10-11** - Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ updated_at:
- Ð£Ð´Ð°Ð»ÐµÐ½ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ adv_params
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° ÑƒÑÐ»Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð² aggregate_adv_params
- updated_at Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ…


